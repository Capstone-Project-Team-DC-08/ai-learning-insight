// Database yang digunakan: PostgreSQL (rekomendasi untuk proyek skala enterprise)
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

// ====================================================================
// 1. Core Users and Authentication
// ====================================================================

model users {
  id                                  Int @id @default(autoincrement())
  display_name                        String?
  name                                String?
  email                               String   @unique // Email harus unik untuk login
  phone                               String?
  // Kolom wajib untuk otentikasi: Menyimpan hash dari password
  password_hash                       String?
  user_role                           String   @default("student") // Role: "student" atau "admin"
  user_verification_status            String?
  image_path                          String?
  city                                String?
  city_id                             Int?
  custom_city                         String?
  tz                                  String?
  verified_at                         DateTime?
  // ... kolom user lainnya

  created_at                          DateTime @default(now())
  updated_at                          DateTime @updatedAt
  deleted_at                          DateTime?
  remember_token                      String?

  // Relasi
  // Pengajar/Reviewer yang mungkin adalah user
  instructed_journeys                 developer_journeys[]       @relation("Instructor")
  reviewed_journeys                   developer_journeys[]       @relation("Reviewer")

  // Aktivitas Pelajar
  developer_journey_trackings         developer_journey_trackings[]
  developer_journey_submissions       developer_journey_submissions[]
  developer_journey_completions       developer_journey_completions[]
  exam_registrations                  exam_registrations[]
  
  // Relasi ke Quiz
  quiz_results                        quiz_results[]

  // insight siswa
  userLearningInsights user_learning_insights[]

  @@map("users")

  enrollments enrollments[]
}

// ====================================================================
// 2. Journey & Tutorial Structures
// ====================================================================

model developer_journeys {
  id                                  Int @id @default(autoincrement())
  name                                String
  summary                             String?
  description                         String?
  point                               Int
  required_point                      Int
  difficulty                          String // misal: beginner, intermediate
  image_path                          String?
  status                              String // misal: published, draft
  listed                              Boolean @default(true)
  hours_to_study                      Int?

  // Relasi FK ke users (opsional/nullable sesuai permintaan)
  instructor_id                       Int?
  reviewer_id                         Int?

  instructor                          users? @relation("Instructor", fields: [instructor_id], references: [id])
  reviewer                            users? @relation("Reviewer", fields: [reviewer_id], references: [id])

  created_at                          DateTime @default(now())
  updated_at                          DateTime @updatedAt

  // Relasi
  developer_journey_tutorials         developer_journey_tutorials[]
  developer_journey_trackings         developer_journey_trackings[]
  developer_journey_submissions       developer_journey_submissions[]
  developer_journey_completions       developer_journey_completions[]

  @@map("developer_journeys")
  enrollments enrollments[]
}

model developer_journey_tutorials {
  id                                  Int @id @default(autoincrement())
  developer_journey_id                Int
  title                               String
  type                                String // misal: article, quiz, submission
  content                             String? // Isi materi (HTML/Markdown/ID Quiz/etc)
  requirements                        Json? // JSON string atau ID dari tutorial yang harus selesai
  position                            Int
  status                              String // misal: published, draft
  trial                               Boolean @default(false)

  created_at                          DateTime @default(now())
  updated_at                          DateTime @updatedAt

  // Relasi
  developer_journey                   developer_journeys @relation(fields: [developer_journey_id], references: [id])
  developer_journey_trackings         developer_journey_trackings[]
  developer_journey_submissions       developer_journey_submissions[]
  exam_registrations                  exam_registrations[]
  
  // Relasi ke Quiz yang menggunakan tutorial ini
  quiz_questions                      quiz_questions[]

  @@map("developer_journey_tutorials")
}

// ====================================================================
// 3. Tracking, Submission, & Completion (Data untuk Insight)
// ====================================================================

model developer_journey_trackings {
  id                                  Int @id @default(autoincrement())
  journey_id                          Int
  tutorial_id                         Int
  developer_id                        Int
  status                              String? // misal: viewed, in_progress, finished
  
  last_viewed                         DateTime?
  first_opened_at                     DateTime @default(now())
  completed_at                        DateTime?

  // Relasi
  journey                             developer_journeys @relation(fields: [journey_id], references: [id])
  tutorial                            developer_journey_tutorials @relation(fields: [tutorial_id], references: [id])
  developer                           users @relation(fields: [developer_id], references: [id])

  @@unique([developer_id, tutorial_id]) // Pelajar hanya bisa memiliki 1 tracking per tutorial

  @@index([developer_id, journey_id, tutorial_id])

  @@map("developer_journey_trackings")
}

model developer_journey_submissions {
  id                                  Int @id @default(autoincrement())
  journey_id                          Int
  quiz_id                             Int // Merujuk ke tutorial bertipe submission
  submitter_id                        Int
  status                              String // misal: submitted, under_review, passed, failed
  app_link                            String?
  app_comment                         String?
  reviewer_id                         Int? // Reviewer yang bertugas

  rating                              Float? // Nilai akhir 0.0 - 5.0
  note                                String? // Feedback

  created_at                          DateTime @default(now())
  updated_at                          DateTime @updatedAt
  
  // Relasi
  journey                             developer_journeys @relation(fields: [journey_id], references: [id])
  quiz                                developer_journey_tutorials @relation(fields: [quiz_id], references: [id])
  submitter                           users @relation(fields: [submitter_id], references: [id])

  @@map("developer_journey_submissions")
}

model developer_journey_completions {
  id                                  Int @id @default(autoincrement())
  user_id                             Int
  journey_id                          Int
  study_duration                      Int? // Durasi belajar total (detik)
  avg_submission_rating               Float? // Rata-rata nilai submission

  created_at                          DateTime @default(now())
  updated_at                          DateTime @updatedAt

  // Relasi
  user                                users @relation(fields: [user_id], references: [id])
  journey                             developer_journeys @relation(fields: [journey_id], references: [id])

  @@unique([user_id, journey_id])
  @@map("developer_journey_completions")
}

// ====================================================================
// 4. Exam/Quiz Structures
// ====================================================================

// Tabel tambahan untuk menyimpan struktur pertanyaan Quiz
model quiz_questions {
  id                                  Int @id @default(autoincrement())
  // Jika quiz terpisah dari tutorial (terdapat banyak pertanyaan), FK ke tutorial
  tutorial_id                         Int // FK ke developer_journey_tutorials (type=quiz)
  question_text                       String
  question_type                       String // misal: multiple_choice, essay

  created_at                          DateTime @default(now())
  updated_at                          DateTime @updatedAt
  
  // Relasi
  tutorial                            developer_journey_tutorials @relation(fields: [tutorial_id], references: [id])
  quiz_options                        quiz_options[]
  
  @@map("quiz_questions")
}

// Tabel tambahan untuk pilihan jawaban Quiz
model quiz_options {
  id                                  Int @id @default(autoincrement())
  question_id                         Int
  option_text                         String
  is_correct                          Boolean @default(false)
  
  created_at                          DateTime @default(now())
  updated_at                          DateTime @updatedAt

  // Relasi
  question                            quiz_questions @relation(fields: [question_id], references: [id])
  
  @@map("quiz_options")
}

// Tabel exam_registrations & exam_results akan digunakan untuk merekam aktivitas
// pengerjaan quiz. Saya tambahkan relasi ke tabel yang baru.

model exam_registrations {
  id                                  Int @id @default(autoincrement())
  exam_module_id                      Int?
  tutorial_id                         Int
  examinees_id                        Int
  status                              String // misal: registered, finished
  
  // ... kolom lainnya
  
  created_at                          DateTime @default(now())
  updated_at                          DateTime @updatedAt
  
  // Relasi
  tutorial                            developer_journey_tutorials @relation(fields: [tutorial_id], references: [id])
  examinees                           users @relation(fields: [examinees_id], references: [id])
  exam_results                        exam_results[]
  
  @@map("exam_registrations")
}

model exam_results {
  id                                  Int @id @default(autoincrement())
  exam_registration_id                Int @unique
  total_questions                     Int
  score                               Float // Skor akhir
  is_passed                           Boolean
  
  // ... kolom lainnya

  created_at                          DateTime @default(now())
  updated_at                          DateTime @updatedAt
  
  // Relasi
  exam_registration                   exam_registrations @relation(fields: [exam_registration_id], references: [id])
  
  @@map("exam_results")
}

// Tabel untuk menyimpan hasil pengerjaan quiz per user
model quiz_results {
  id                                  Int @id @default(autoincrement())
  user_id                             Int
  quiz_id                             Int // Merujuk ke tutorial bertipe quiz

  // Hasil pengerjaan
  score                               Float
  time_taken_seconds                  Int

  created_at                          DateTime @default(now())
  updated_at                          DateTime @updatedAt

  // Relasi
  user                                users @relation(fields: [user_id], references: [id])

  @@map("quiz_results")
}

model user_learning_insights {
  id          Int      @id @default(autoincrement())
  user_id     Int
  insight_key String   // misal: "predicted_dropout_risk", "recommended_next_course"
  insight_val Json     // Data hasil analisis
  created_at  DateTime @default(now())

  user        users    @relation(fields: [user_id], references: [id])

  @@index([user_id])
}

model enrollments {
  id          Int      @id @default(autoincrement())
  user_id     Int
  journey_id  Int
  status      String   @default("active") // active, completed, dropped
  enrolled_at DateTime @default(now())
  
  // Opsional: Cache progress agar tidak perlu hitung manual setiap saat
  current_progress Float @default(0.0) 
  last_accessed_at DateTime?

  user    users              @relation(fields: [user_id], references: [id])
  journey developer_journeys @relation(fields: [journey_id], references: [id])

  @@unique([user_id, journey_id]) // Satu user hanya bisa enroll 1x per kelas
  @@index([user_id])
  @@map("enrollments")
}